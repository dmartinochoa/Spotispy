<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Spotispy -
        <%= data.username %>
    </title>
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900italic,900' rel='stylesheet' type='text/css'>
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css'>
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css'>
    <link rel='stylesheet' href='https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css'>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.3.0/nouislider.min.css'>
    <link rel="stylesheet" href="../styles/spoty.css">
</head>

<body>
    <span style="display:none;" id="data">
        <%=data %>
    </span>

    <section class="header">

        <div class="page-flows">
            <span class="flow">
                <i class="ion-chevron-left"></i>
            </span>
            <span class="flow">
                <i class="ion-chevron-right disabled"></i>
            </span>
        </div>

        <div class="search">
            <input type="text" placeholder="Search" id="searchbar" />
        </div>

        <div class="user">

            <div class="user_nearby user__actions">
                <div class="dropdown">
                    <button class="dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        <i class="ion-radio-waves"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-right" id="nearby_list" aria-labelledby="dropdownMenu1">
                        <li><a href="#">Reload</a></li>
                    </ul>
                </div>
            </div>


            <div class="user_nearby user__actions user_notifications">
                <div class="dropdown">
                    <button class="dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        <i class="ion-android-notifications"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-right" id="nearby_list" aria-labelledby="dropdownMenu1">
                        <li><a href="#">Reload</a></li>
                    </ul>
                </div>
            </div>


            <div class="user_nearby user__actions user_friends">
                <div class="dropdown">
                    <button class="dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                            <i class="ion-person-stalker"></i>
                        </button>
                    <ul class="dropdown-menu dropdown-menu-right" id="nearby_list" aria-labelledby="dropdownMenu1">
                        <li><a href="#">Reload</a></li>
                    </ul>
                </div>
            </div>


            <div class="user__info">
                <span class="user__info__img">
                    <img src="../favicon.ico" alt="Profile Picture"
                        class="img-responsive" />
                </span>

                <span class="user__info__name">
                    <span class="first"><%= data.username %></span>
                </span>
            </div>

            <div class="user__actions">
                <div class="dropdown">
                    <button class="dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        <i class="ion-chevron-down"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">
                        <li><a href="#">Private Session</a></li>
                        <li><a href="#">Account</a></li>
                        <li><a href="#">Settings</a></li>
                        <li><a href="https://localhost:3000/">Log Out</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="content__left">
            <section class="navigation">

                <!-- Your Music -->
                <div class="navigation__list">
                    <div class="navigation__list__header" role="button" data-toggle="collapse" href="#yourMusic" aria-expanded="true" aria-controls="yourMusic">
                        Your Music
                    </div>
                    <div class="collapse in" id="yourMusic">
                        <a href="#" class="navigation__list__item">
                            <i class="ion-headphone"></i>
                            <span>Songs</span>
                        </a>
                        <a href="#" class="navigation__list__item">
                            <i class="ion-ios-musical-notes"></i>
                            <span>Albums</span>
                        </a>
                        <a href="#" class="navigation__list__item">
                            <i class="ion-person"></i>
                            <span>Artists</span>
                        </a>
                        <a href="#" class="navigation__list__item">
                            <i class="ion-document"></i>
                            <span>Local Files</span>
                        </a>
                    </div>
                </div>
                <!-- / -->

                <!-- Widget -->
                <div id='widgetPlayer'></div>
                <!-- / -->
            </section>
        </div>

        <div class="content__middle">
            <div class="artist is-verified">
                <div class="artist__content">
                    <div class="tab-content">

                        <!-- Overview -->
                        <div class="overview">
                            <div id="tracks" style="width: 100%;"></div>
                            <div class="section-title" style="width: 100%;" id="albums"></div>

                            <div class="media-cards" style="width: 100%;" id="artists"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content__right">
            <div class="social">
                <div class="friends" id="friends">
                    <button class="button-light">Find Friends</button>
                </div>

            </div>
        </div>
    </section>

    <section class="current-track">
        <div class="current-track__actions" id="current-track__actions">
            <a class="ion-ios-skipbackward"></a>
            <div id="play_pause">
                <a class="ion-ios-play" id="play"></a>
                <a class="ion-ios-pause" id="pause" style="display: none;"></a>
            </div>

            <a class="ion-ios-skipforward"></a>
        </div>

        <div class="current-track__progress">
            <div class="current-track__progress__start">0:00</div>
            <div class="current-track__progress__bar">
                <div id="song-progress"></div>
            </div>

            <div class="current-track__progress__finish">0:00</div>
        </div>

        <div class="current-track__options">
            <a href="#" class="lyrics">Lyrics</a>
            <span class="controls">

                <a href="#" class="control">
                    <i class="ion-navicon"></i>
                </a>

                <a href="#" class="control">
                    <i class="ion-shuffle"></i>
                </a>

                <a href="#" class="control">
                    <i class="fa fa-refresh"></i>
                </a>

                <a href="#" class="control devices" id="devices">
                    <i class="ion-iphone"></i>
                    <span>Devices Available</span>
            </a>
            <input type="number" name="volume" id="volume_input" value="100" oninput="change_volume()" maxlength="3" min="0" max="100">
            <a href="#" class="control volume">
                <i class="ion-volume-high"></i>
                <div id="song-volume"></div>
            </a>
            </span>
        </div>
    </section>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.3.0/nouislider.min.js'></script>
    <script src="../scripts/noUiSlider.js"></script>
    <script src="../scripts/home.js"></script>
    <script src="../scripts/player.js"></script>
    <script src="../scripts/geo.js"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script src="../scripts/web_player_sdk.js"></script>

    <script>
        var server_data = '<%- JSON.stringify(data) %>'
        server_data = JSON.parse(server_data)
        var token = server_data.token
        var refresh_token = server_data.refresh_token
        const progress_bar = document.querySelector('.noUi-origin')
        const volume_bar = document.querySelector('.noUi-origin')
        const song_duration = document.querySelector('.current-track__progress__finish')
        const song_timestamp = document.querySelector('.current-track__progress__start')
        window.onSpotifyWebPlaybackSDKReady = () => {

            const player = new Spotify.Player({
                name: 'Spotispy',
                getOAuthToken: callback => {
                    // Run code to get a fresh access token
                    callback(token);
                }
            });

            // Error handling
            player.addListener('initialization_error', ({
                message
            }) => {
                console.error(message);
            });
            player.addListener('authentication_error', ({
                message
            }) => {
                console.error(message);
            });
            player.addListener('account_error', ({
                message
            }) => {
                console.error(message);
            });
            player.addListener('playback_error', ({
                message
            }) => {
                console.error(message);
            });

            // Playback status updates
            player.addListener('player_state_changed', state => {
                var msg = 'Now playing: ' + state.track_window.current_track.name + ' by ' + state.track_window.current_track.artists[0].name
                console.log(msg)

                var track_progress = (state.position / state.duration) * 100
                progress_bar.style.left = track_progress + '%'
            });

            // Ready
            player.addListener('ready', ({
                device_id
            }) => {
                new_device = device_id
                console.log('Ready with Device ID', device_id);
            });

            // Not Ready
            player.addListener('not_ready', ({
                device_id
            }) => {
                console.log('Device ID has gone offline', device_id);
            });

            // player.addListener('update', ({
            //     device_id
            // }) => {
            //     console.log('wtf');
            // });

            player.resume().then(() => {
                console.log('Resumed!');
            });

            // Connect to the player!
            player.connect();
        };


        // player.on('update', response => {
        //     console.log('jesus save us')
        //     track_progress = (response.progress_ms * 100) / response.item.duration_ms
        //     progress_bar.style.left = track_progress + '%'
        // });
    </script>
</body>


</html>